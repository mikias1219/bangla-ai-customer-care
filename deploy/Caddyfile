# Caddyfile for Bangla AI Platform with automatic HTTPS
# Place in /etc/caddy/Caddyfile and run 'sudo systemctl restart caddy'

# Main domain - dashboard with API proxy
yourdomain.com {
    # Enable automatic HTTPS
    tls {
        protocols tls1.2 tls1.3
    }

    # Dashboard static files (served from nginx container)
    root * /usr/share/nginx/html
    try_files {path} {path}/ /index.html
    file_server

    # API proxy to backend
    handle_path /api/* {
        uri strip_prefix /api
        reverse_proxy localhost:8000
    }

    # Channel webhooks
    handle_path /channels/* {
        reverse_proxy localhost:8000
    }

    # Admin API
    handle_path /admin/* {
        reverse_proxy localhost:8000
    }

    # Auth endpoints
    handle_path /auth/* {
        reverse_proxy localhost:8000
    }

    # Health check
    handle /health {
        reverse_proxy localhost:8000
    }

    # Metrics
    handle /metrics {
        reverse_proxy localhost:8000
    }

    # API docs
    handle /docs {
        reverse_proxy localhost:8000
    }

    handle /redoc {
        reverse_proxy localhost:8000
    }

    handle /openapi.json {
        reverse_proxy localhost:8000
    }

    # WebSocket support for chat
    handle /ws {
        reverse_proxy localhost:8000 {
            # WebSocket headers
            header_up Upgrade {header.Upgrade}
            header_up Connection {header.Connection}
        }
    }

    # Security headers
    header {
        # Enable HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' wss: https:;"
    }

    # Gzip compression
    encode gzip

    # Rate limiting (optional)
    rate_limit {
        zone static {
            key {remote}
            window 1m
            events 100
        }
    }
}

# Optional: separate API subdomain
api.yourdomain.com {
    tls {
        protocols tls1.2 tls1.3
    }

    # Proxy everything to backend
    reverse_proxy localhost:8000

    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        X-Content-Type-Options "nosniff"
    }

    encode gzip
}
