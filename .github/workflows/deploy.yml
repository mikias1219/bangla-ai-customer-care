name: Deploy Bangla AI Customer Care

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  DOMAIN: bdchatpro.com
  FRONTEND_PORT: 3002
  BACKEND_PORT: 8000
  SSH_HOST: ${{ secrets.VPS_HOST }}
  SSH_USER: ${{ secrets.VPS_USER }}
  SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
  SSL_EMAIL: ${{ secrets.SSL_EMAIL }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" | tr -d '\r' | sed 's/^ *//;s/ *$//' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          if ! ssh-keygen -l -f ~/.ssh/id_rsa > /dev/null 2>&1; then
            echo "âŒ Invalid SSH key format"
            exit 1
          fi
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $SSH_USER@$SSH_HOST "echo 'SSH connection successful'"

      - name: Prepare Server for Deployment
        run: |
          echo "ðŸ§¹ Running server cleanup and fixes..."
          scp -o StrictHostKeyChecking=no deploy/cleanup-server.sh $SSH_USER@$SSH_HOST:/tmp/
          scp -o StrictHostKeyChecking=no deploy/fix-dpkg.sh $SSH_USER@$SSH_HOST:/tmp/
          scp -o StrictHostKeyChecking=no deploy/quick-fix-nodejs.sh $SSH_USER@$SSH_HOST:/tmp/
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "chmod +x /tmp/cleanup-server.sh /tmp/fix-dpkg.sh /tmp/quick-fix-nodejs.sh && sudo /tmp/fix-dpkg.sh && sudo /tmp/quick-fix-nodejs.sh && sudo /tmp/cleanup-server.sh"

      - name: System Update and Package Installation
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'EOF'
            set -e
            echo "ðŸ”„ Updating system packages..."
            sudo apt update && sudo apt upgrade -y

            echo "ðŸ“¦ Installing required packages..."
            sudo apt install -y nginx python3 python3-pip python3-venv curl

            echo "ðŸ” Verifying installations..."
            node --version && echo "âœ… Node.js: $(node --version)"
            npm --version && echo "âœ… npm: $(npm --version)"
            python3 --version && echo "âœ… Python: $(python3 --version)"
            pip3 --version && echo "âœ… pip: $(pip3 --version)"
            nginx -v && echo "âœ… Nginx installed"

            echo "âœ… System update and package installation completed"
          EOF

      - name: Setup SSL Certificates
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'EOF'
            set -e
            echo "ðŸ”’ Installing Certbot for SSL certificates..."
            sudo apt install -y certbot python3-certbot-nginx
            echo "ðŸ“œ Obtaining SSL certificate for $DOMAIN..."
            sudo certbot certonly --standalone \
              --non-interactive \
              --agree-tos \
              --email $SSL_EMAIL \
              -d $DOMAIN \
              -d www.$DOMAIN
            echo "âœ… SSL certificates setup completed"
          EOF

      - name: Create Project Directory and Setup
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'EOF'
            set -e
            echo "ðŸ“ Creating project directory..."
            sudo mkdir -p /opt/bangla-ai-customer-care
            sudo chown $USER:$USER /opt/bangla-ai-customer-care
            echo "ðŸ›‘ Stopping existing services..."
            sudo systemctl stop bangla-frontend 2>/dev/null || true
            sudo systemctl stop bangla-backend 2>/dev/null || true
            echo "âœ… Project directory setup completed"
          EOF

      - name: Deploy Backend
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'EOF'
            set -e
            echo "ðŸ”§ Setting up backend..."
            cd /opt/bangla-ai-customer-care
            echo "ðŸ“‹ Copying backend files..."
            cp -r $GITHUB_WORKSPACE/backend .
            echo "ðŸ Installing backend dependencies..."
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            pip install fastapi uvicorn sqlalchemy alembic redis httpx aiohttp requests python-jose passlib python-multipart prometheus-client openai python-dateutil pytz fuzzywuzzy python-levenshtein numpy
            echo "âš™ï¸ Creating environment configuration..."
            cat > .env << ENV_EOF
            BANG_OPENAI_API_KEY=${{ secrets.OPENAI_API }}
            BANG_DATABASE_URL=sqlite:///./bangla.db
            BANG_SECRET_KEY=$(openssl rand -hex 32)
            BANG_CORS_ORIGINS=["https://$DOMAIN", "http://localhost:3000"]
            BANG_REDIS_URL=redis://localhost:6379/0
            ENV_EOF
            echo "âœ… Backend deployment completed"
          EOF

      - name: Deploy Frontend
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'EOF'
            set -e
            echo "ðŸŽ¨ Setting up frontend..."
            cd /opt/bangla-ai-customer-care
            echo "ðŸ“‹ Copying frontend files..."
            cp -r $GITHUB_WORKSPACE/frontend .
            echo "ðŸ“¦ Installing Node.js dependencies..."
            cd frontend
            npm install
            echo "ðŸ”¨ Building React application..."
            if [ -d "dashboard" ]; then
              cd dashboard
              npm install
              npm run build
              cd ..
              cp -r dashboard/dist/* . 2>/dev/null || true
            fi
            cd ..
            echo "âœ… Frontend deployment completed"
          EOF

      - name: Configure Nginx
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'EOF'
            set -e
            echo "âš™ï¸ Configuring Nginx..."
            sudo tee /etc/nginx/sites-available/bangla > /dev/null << NGINX_EOF
            server {
                listen 80;
                listen [::]:80;
                server_name $DOMAIN www.$DOMAIN;
                return 301 https://\$server_name\$request_uri;
            }

            server {
                listen 443 ssl http2;
                listen [::]:443 ssl http2;
                server_name $DOMAIN www.$DOMAIN;

                ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;
                ssl_protocols TLSv1.2 TLSv1.3;
                ssl_ciphers HIGH:!aNULL:!MD5;
                ssl_prefer_server_ciphers on;
                ssl_session_cache shared:SSL:10m;
                ssl_session_timeout 10m;

                location / {
                    proxy_pass http://127.0.0.1:$FRONTEND_PORT;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                    proxy_cache_bypass \$http_upgrade;
                    proxy_buffering off;
                    proxy_request_buffering off;
                }

                location /api/ {
                    proxy_pass http://127.0.0.1:$BACKEND_PORT/;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection "upgrade";
                }

                location /channels/ {
                    proxy_pass http://127.0.0.1:$BACKEND_PORT/channels/;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                }

                location /health {
                    proxy_pass http://127.0.0.1:$BACKEND_PORT/health;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                }

                gzip on;
                gzip_vary on;
                gzip_min_length 1024;
                gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
            }
            NGINX_EOF

            sudo ln -sf /etc/nginx/sites-available/bangla /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo nginx -t && sudo systemctl reload nginx
            echo "âœ… Nginx configuration completed"
          EOF

      - name: Setup Systemd Services
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'EOF'
            set -e
            echo "ðŸ”„ Setting up systemd services..."

            sudo tee /etc/systemd/system/bangla-frontend.service > /dev/null << FRONTEND_SERVICE_EOF
            [Unit]
            Description=Bangla Frontend (Node.js)
            After=network.target

            [Service]
            Type=simple
            User=$USER
            WorkingDirectory=/opt/bangla-ai-customer-care/frontend
            ExecStart=/usr/bin/node server.js
            Restart=always
            RestartSec=5
            Environment=PORT=$FRONTEND_PORT

            [Install]
            WantedBy=multi-user.target
            FRONTEND_SERVICE_EOF

            sudo tee /etc/systemd/system/bangla-backend.service > /dev/null << BACKEND_SERVICE_EOF
            [Unit]
            Description=Bangla Backend (FastAPI)
            After=network.target

            [Service]
            Type=simple
            User=$USER
            WorkingDirectory=/opt/bangla-ai-customer-care/backend
            Environment="PATH=/opt/bangla-ai-customer-care/backend/venv/bin"
            ExecStart=/opt/bangla-ai-customer-care/backend/venv/bin/python -m uvicorn app.main:app --host 127.0.0.1 --port $BACKEND_PORT
            Restart=always
            RestartSec=5

            [Install]
            WantedBy=multi-user.target
            BACKEND_SERVICE_EOF

            sudo systemctl daemon-reload
            sudo systemctl enable bangla-frontend
            sudo systemctl enable bangla-backend
            echo "âœ… Systemd services setup completed"
          EOF

      - name: Start Services and Test Deployment
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'EOF'
            set -e
            echo "â–¶ï¸ Starting services..."
            sudo systemctl start bangla-frontend
            sudo systemctl start bangla-backend

            echo "ðŸ§ª Testing deployment..."
            sleep 10

            echo "ðŸ“Š Services status:"
            sudo systemctl status bangla-frontend --no-pager -l || echo "âŒ Frontend status check failed"
            sudo systemctl status bangla-backend --no-pager -l || echo "âŒ Backend status check failed"

            echo "ðŸŒ Testing endpoints..."
            curl -k https://$DOMAIN/health && echo "âœ… Health check passed" || echo "âŒ Health check failed"
            curl -I https://$DOMAIN | head -1 && echo "âœ… HTTPS working" || echo "âŒ HTTPS failed"

            echo "âœ… Deployment completed successfully!"
            echo "ðŸŒ Frontend: https://$DOMAIN (port $FRONTEND_PORT)"
            echo "ðŸ”§ Backend: http://localhost:$BACKEND_PORT"
            echo "ðŸ”’ SSL: Let's Encrypt certificate for $DOMAIN"
          EOF
